<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTP/HTTPS ä»£ç†ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 600; }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        button:active { transform: translateY(0); }
        .btn-secondary { background: #6c757d; margin-top: 5px; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-danger {
            background: #dc3545;
            padding: 6px 12px;
            width: auto;
            margin: 0;
        }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .rules-list { margin-top: 20px; }
        .rule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 5px solid #667eea;
            transition: all 0.3s;
        }
        .rule-item:hover { background: #e9ecef; transform: translateX(5px); }
        .rule-item .source { color: #667eea; font-weight: 700; font-size: 1.05em; }
        .rule-item .arrow { margin: 0 15px; color: #999; font-weight: bold; font-size: 1.2em; }
        .rule-item .target { color: #28a745; font-weight: 700; font-size: 1.05em; }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .cert-status {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .cert-status.success { background: #d4edda; border: 2px solid #c3e6cb; }
        .cert-status.warning { background: #fff3cd; border: 2px solid #ffeaa7; }
        .cert-status h3 { margin-bottom: 10px; font-size: 1.3em; }
        .cert-status p { margin: 5px 0; }
        .step-guide {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .step-guide h4 { color: #667eea; margin-bottom: 15px; font-size: 1.2em; }
        .step-guide ol { margin-left: 20px; line-height: 2; color: #555; }
        .step-guide li { margin-bottom: 8px; }
        .highlight { background: #fff3e0; padding: 2px 8px; border-radius: 4px; font-weight: 600; }
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .status-badge.online { background: #d4edda; color: #155724; }
        .status-badge.offline { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ MITM ä»£ç†ç®¡ç†ç³»ç»Ÿ</h1>
            <p>æ”¯æŒHTTPSåŸŸåæ˜ å°„çš„æ™ºèƒ½ä»£ç†æœåŠ¡å™¨</p>
        </div>
        
        <div class="main-grid">
            <!-- CAè¯ä¹¦è®¾ç½® -->
            <div class="card">
                <h2>ğŸ”’ CAè¯ä¹¦è®¾ç½®</h2>
                <div id="alerts"></div>
                
                <div id="certStatus" class="cert-status">
                    <h3 id="certStatusTitle">æ£€æŸ¥ä¸­...</h3>
                    <p id="certStatusText">æ­£åœ¨æ£€æŸ¥CAè¯ä¹¦çŠ¶æ€</p>
                </div>
                
                <button onclick="importCaCert()" class="btn-success" id="importCertBtn">ğŸ” ä¸€é”®å¯¼å…¥CAè¯ä¹¦åˆ°ç³»ç»Ÿ</button>
                
                <div class="step-guide" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
                    <h4>âœ… è‡ªåŠ¨å¯¼å…¥è¯´æ˜</h4>
                    <p style="color: #1b5e20; line-height: 1.8; margin: 0;">
                        ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†CAè¯ä¹¦å¯¼å…¥åˆ°å—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„ã€‚
                        Windows/Linuxå¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™ï¼ˆsudoï¼‰ã€‚
                    </p>
                </div>
                
                <div class="step-guide" style="background: #e3f2fd; border-left: 4px solid #2196f3;">
                    <h4>ğŸ“‹ å„å¹³å°æ”¯æŒ</h4>
                    <ul style="color: #0d47a1; line-height: 1.8; margin: 0; padding-left: 20px;">
                        <li><strong>Windows:</strong> ä½¿ç”¨certutilè‡ªåŠ¨å¯¼å…¥åˆ°ROOTå­˜å‚¨</li>
                        <li><strong>macOS:</strong> ä½¿ç”¨securityå‘½ä»¤å¯¼å…¥åˆ°ç³»ç»Ÿé’¥åŒ™ä¸²</li>
                        <li><strong>Linux:</strong> å¤åˆ¶åˆ°ç³»ç»Ÿè¯ä¹¦ç›®å½•å¹¶æ›´æ–°</li>
                    </ul>
                </div>
                
                <div class="step-guide" style="background: #fff3e0; border-left: 4px solid #ff9800;">
                    <h4>âš ï¸ å®‰å…¨è¯´æ˜</h4>
                    <p style="color: #e65100; line-height: 1.8; margin: 0;">
                        â€¢ CAè¯ä¹¦æ˜¯æœ¬åœ°çš„ï¼Œç”¨äºä»£ç†HTTPSæµé‡<br>
                        â€¢ ä¸ä¼šæ”¶é›†æˆ–æ³„éœ²ä½ çš„æ•°æ®<br>
                        â€¢ å¯ä»¥åœ¨ç³»ç»Ÿè®¾ç½®ä¸­éšæ—¶å¸è½½æ­¤è¯ä¹¦
                    </p>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿè®¾ç½® -->
            <div class="card">
                <h2>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
                
                <div class="form-group">
                    <label for="portInput">ç›‘å¬ç«¯å£</label>
                    <input type="number" id="portInput" min="1" max="65535" placeholder="8080" />
                </div>
                
                <div class="form-group">
                    <label for="logLevel">æ—¥å¿—çº§åˆ«</label>
                    <select id="logLevel">
                        <option value="DEBUG">DEBUG</option>
                        <option value="INFO" selected>INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                    </select>
                </div>
                
                <button onclick="saveSettings()" class="btn-success">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                <button onclick="loadConfig()" class="btn-secondary">ğŸ”„ é‡æ–°åŠ è½½</button>
            </div>
        </div>
        
        <div class="main-grid">
            <!-- åŸŸåæ˜ å°„è§„åˆ™ -->
            <div class="card">
                <h2>ğŸ“ åŸŸåæ˜ å°„è§„åˆ™</h2>
                
                <div class="form-group">
                    <label for="sourceInput">æºåŸŸå (è®¿é—®çš„åŸŸå)</label>
                    <input type="text" id="sourceInput" placeholder="ä¾‹å¦‚: www.aardio.com" />
                </div>
                
                <div class="form-group">
                    <label for="targetInput">ç›®æ ‡åŸŸå (å®é™…è®¿é—®çš„åŸŸå)</label>
                    <input type="text" id="targetInput" placeholder="ä¾‹å¦‚: www.achui.cn" />
                </div>
                
                <button onclick="addRule()" class="btn-success">â• æ·»åŠ æ˜ å°„è§„åˆ™</button>
                
                <div class="rules-list">
                    <h3 style="margin-top: 20px; margin-bottom: 10px; color: #555;">å½“å‰è§„åˆ™åˆ—è¡¨</h3>
                    <div id="rulesList"></div>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿä»£ç†è®¾ç½® -->
            <div class="card">
                <h2>ğŸ–¥ï¸ ç³»ç»Ÿä»£ç†è®¾ç½®</h2>
                
                <div class="step-guide" style="background: #e3f2fd; border-left: 4px solid #2196f3;">
                    <h4 style="color: #0d47a1;">ğŸ”§ Windows ä»£ç†é…ç½®</h4>
                    <ol style="color: #0d47a1;">
                        <li>æŒ‰ <span class="highlight">Win + I</span> æ‰“å¼€è®¾ç½®</li>
                        <li>é€‰æ‹©"ç½‘ç»œå’ŒInternet" â†’ "ä»£ç†"</li>
                        <li>å¼€å¯"ä½¿ç”¨ä»£ç†æœåŠ¡å™¨"</li>
                        <li>åœ°å€ï¼š<span class="highlight">127.0.0.1</span></li>
                        <li>ç«¯å£ï¼š<span class="highlight" id="proxyPortDisplay">28456</span></li>
                        <li>ç‚¹å‡»"ä¿å­˜"</li>
                    </ol>
                </div>
                
                <div class="step-guide" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
                    <h4 style="color: #1b5e20;">ğŸ“– ä½¿ç”¨è¯´æ˜</h4>
                    <ul style="color: #1b5e20; line-height: 2; list-style: none; padding: 0;">
                        <li>âœ… é…ç½®äº†æ˜ å°„è§„åˆ™çš„åŸŸå â†’ è½¬å‘åˆ°ç›®æ ‡åŸŸå</li>
                        <li>âœ… æœªé…ç½®è§„åˆ™çš„åŸŸå â†’ åŸæ ·è®¿é—®</li>
                        <li>âœ… æ”¯æŒHTTPå’ŒHTTPSåè®®</li>
                        <li>âœ… æ”¯æŒSSEæµå¼ä¼ è¾“</li>
                    </ul>
                </div>
                
                <div class="step-guide" style="background: #fff3e0; border-left: 4px solid #ff9800;">
                    <h4 style="color: #e65100;">ğŸ’¡ å·¥ä½œåŸç†</h4>
                    <p style="color: #e65100; line-height: 1.8; margin: 0;">
                        æµè§ˆå™¨é…ç½®ä»£ç†åï¼Œæ‰€æœ‰æµé‡éƒ½ç»è¿‡æ­¤æœåŠ¡å™¨ã€‚
                        æœåŠ¡å™¨æ£€æŸ¥è¯·æ±‚çš„åŸŸåæ˜¯å¦åœ¨æ˜ å°„è§„åˆ™ä¸­ï¼Œ
                        å¦‚æœæœ‰è§„åˆ™ï¼Œä½¿ç”¨MITMæŠ€æœ¯æ‹¦æˆªHTTPSè¿æ¥å¹¶é‡æ–°ç­¾åè¯ä¹¦ï¼Œ
                        ç„¶åè½¬å‘åˆ°ç›®æ ‡åŸŸåã€‚
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof pywebview !== 'undefined') {
                loadConfig();
            } else {
                window.addEventListener('pywebviewready', loadConfig);
            }
        });
        
        async function loadConfig() {
            try {
                const config = await pywebview.api.get_config();
                document.getElementById('portInput').value = config.port || 8080;
                document.getElementById('logLevel').value = config.log_level || 'INFO';
                document.getElementById('proxyPortDisplay').textContent = config.port || 8080;
                
                // æ£€æŸ¥CAè¯ä¹¦çŠ¶æ€
                await checkCertStatus();
                
                loadRules();
            } catch (error) {
                showAlert('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function checkCertStatus() {
            try {
                const status = await pywebview.api.get_https_status();
                const certDiv = document.getElementById('certStatus');
                const title = document.getElementById('certStatusTitle');
                const text = document.getElementById('certStatusText');
                
                if (status.ca_cert_exists) {
                    certDiv.className = 'cert-status success';
                    title.innerHTML = 'âœ… CAè¯ä¹¦å·²å°±ç»ª';
                    text.innerHTML = `è¯ä¹¦è·¯å¾„: <span class="highlight">${status.ca_cert_path}</span>`;
                } else {
                    certDiv.className = 'cert-status warning';
                    title.innerHTML = 'âš ï¸ CAè¯ä¹¦æœªç”Ÿæˆ';
                    text.textContent = 'ä»£ç†æœåŠ¡å™¨é¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨ç”ŸæˆCAè¯ä¹¦';
                }
            } catch (error) {
                showAlert('æ£€æŸ¥è¯ä¹¦çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function importCaCert() {
            try {
                const result = await pywebview.api.import_ca_cert();
                if (result.status === 'success') {
                    showAlert('âœ… å·²æ‰“å¼€è¯ä¹¦æ–‡ä»¶ï¼Œè¯·æŒ‰ç…§æç¤ºå¯¼å…¥åˆ°æµè§ˆå™¨', 'success');
                } else {
                    showAlert('æ‰“å¼€è¯ä¹¦å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('å¯¼å…¥è¯ä¹¦å‡ºé”™: ' + error.message, 'error');
            }
        }
        
        async function loadRules() {
            try {
                const rules = await pywebview.api.get_rules();
                const rulesList = document.getElementById('rulesList');
                rulesList.innerHTML = '';
                
                if (Object.keys(rules).length === 0) {
                    rulesList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— æ˜ å°„è§„åˆ™</p>';
                    return;
                }
                
                for (const [source, target] of Object.entries(rules)) {
                    const ruleItem = document.createElement('div');
                    ruleItem.className = 'rule-item';
                    ruleItem.innerHTML = `
                        <div>
                            <span class="source">${escapeHtml(source)}</span>
                            <span class="arrow">â†’</span>
                            <span class="target">${escapeHtml(target)}</span>
                        </div>
                        <button class="btn-danger" onclick="deleteRule('${escapeHtml(source)}')">åˆ é™¤</button>
                    `;
                    rulesList.appendChild(ruleItem);
                }
            } catch (error) {
                showAlert('åŠ è½½è§„åˆ™å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function addRule() {
            const source = document.getElementById('sourceInput').value.trim();
            const target = document.getElementById('targetInput').value.trim();
            
            if (!source || !target) {
                showAlert('è¯·è¾“å…¥æºåŸŸåå’Œç›®æ ‡åŸŸå', 'error');
                return;
            }
            
            try {
                const result = await pywebview.api.add_rule(source, target);
                if (result.status === 'success') {
                    document.getElementById('sourceInput').value = '';
                    document.getElementById('targetInput').value = '';
                    showAlert(`âœ… æ·»åŠ æˆåŠŸ: ${source} â†’ ${target}`, 'success');
                    loadRules();
                } else {
                    showAlert('æ·»åŠ å¤±è´¥: ' + (result.message || ''), 'error');
                }
            } catch (error) {
                showAlert('æ·»åŠ è§„åˆ™å‡ºé”™: ' + error.message, 'error');
            }
        }
        
        async function deleteRule(source) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è§„åˆ™: ${source}?`)) return;
            try {
                const result = await pywebview.api.delete_rule(source);
                if (result.status === 'success') {
                    showAlert(`âœ… åˆ é™¤æˆåŠŸ: ${source}`, 'success');
                    loadRules();
                } else {
                    showAlert('åˆ é™¤å¤±è´¥: ' + (result.message || ''), 'error');
                }
            } catch (error) {
                showAlert('åˆ é™¤è§„åˆ™å‡ºé”™: ' + error.message, 'error');
            }
        }
        
        async function saveSettings() {
            const port = parseInt(document.getElementById('portInput').value) || 8080;
            const logLevel = document.getElementById('logLevel').value;
            
            const currentConfig = await pywebview.api.get_config();
            const rules = await pywebview.api.get_rules();
            
            const config = {
                proxy_rules: rules,
                port: port,
                log_level: logLevel
            };
            
            try {
                const result = await pywebview.api.update_config(config);
                if (result) {
                    showAlert('âœ… ä¿å­˜æˆåŠŸï¼è¯·é‡å¯åº”ç”¨ç”Ÿæ•ˆ', 'success');
                    document.getElementById('proxyPortDisplay').textContent = port;
                } else {
                    showAlert('ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('ä¿å­˜è®¾ç½®å‡ºé”™: ' + error.message, 'error');
            }
        }
        
        function showAlert(message, type = 'info') {
            const alertDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            alertDiv.appendChild(alert);
            
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transform = 'translateY(-10px)';
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
